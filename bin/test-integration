#!/usr/bin/env bash

set -eux -o pipefail

bin=$(dirname "$0")

base=$( cd "${bin}"/.. && pwd )
workspace_dir=$( cd "${bin}"/../.. && pwd )

if [ ! -d "${base}"/tmp ]; then
  mkdir -p "${base}"/tmp
fi

if ! docker network ls | grep director_network; then
  docker network create --subnet=10.80.54.0/16 director_network
fi

docker_host="unix:///var/run/docker.sock"
agent_ip="10.80.54.5"
blobstore_registry_ip="10.80.54.6"
bosh create-env ${base}/integration/assets/agent-deployment.yml \
  -v internal_cidr=10.80.54.0/16 \
  -v internal_gw=10.80.54.1 \
  -v internal_ip="${agent_ip}" \
  -v network=director_network \
  -v docker_host=${docker_host} \
  -v docker_tls=${DOCKER_TLS:-"((docker_tls))"} \
  --vars-store="${base}/tmp/agent-creds.yml" \
  --state="${base}/tmp/agent-state.json"

cd $base
echo -e "\n Running agent integration tests..."
go clean -r github.com/cloudfoundry/bosh-agent/
bin/build

bosh interpolate --path=/ssh_creds/private_key tmp/agent-creds.yml > private_jumpbox_key
chmod 600 private_jumpbox_key
mkdir -p ~/.ssh
ssh-keyscan -H ${agent_ip} >> ~/.ssh/known_hosts

apt-get -y install expect 

expect -d -c $'
  set timeout 100
  spawn ssh -t vcap@'${agent_ip}$' -i private_jumpbox_key 
  expect {*bosh/0*}
  send {echo "vcap ALL=(ALL) NOPASSWD: ALL" | sudo tee -a /etc/sudoers\r}
  expect {\[sudo\] password for vcap: }
  send {c1oudc0w\r}
  expect {*bosh/0*}
'
ssh -t vcap@${agent_ip} -i private_jumpbox_key "sudo mkdir -p /home/vagrant/go/src/github.com/cloudfoundry/bosh-agent/tmp/ && sudo chown vcap:vcap /home/vagrant/go/src/github.com/cloudfoundry/bosh-agent/tmp/"
ssh -t vcap@${agent_ip} -i private_jumpbox_key "sudo chmod o+x /var/vcap/bosh && sudo chown vcap:vcap /var/vcap/bosh/bin/bosh-agent"
ssh -t vcap@${agent_ip} -i private_jumpbox_key "sudo sv stop agent"
scp -i private_jumpbox_key out/bosh-agent vcap@${agent_ip}:/var/vcap/bosh/bin/bosh-agent 
ssh -t vcap@${agent_ip} -i private_jumpbox_key "sudo sv start agent"

go build -o fake-registry github.com/cloudfoundry/bosh-agent/integration/fake-registry
scp -i private_jumpbox_key fake-registry vcap@${agent_ip}:/home/vagrant/go/src/github.com/cloudfoundry/bosh-agent/tmp/fake-registry

go build -o fake-blobstore github.com/cloudfoundry/bosh-agent/integration/fake-blobstore
scp -i private_jumpbox_key fake-blobstore vcap@${agent_ip}:/home/vagrant/go/src/github.com/cloudfoundry/bosh-agent/tmp/fake-blobstore
echo "EVERYTHING WORKS UNTIL HERE! :)"
exit 0